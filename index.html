<!DOCTYPE html>
<html>

<head>
    <title>Marker-based Animal AR - Emotion Switch</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <style>
        .ui-button {
            position: absolute;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #333;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .ui-button:active {
            transform: scale(0.95);
            background: rgba(200, 200, 200, 0.9);
        }

        #happy-btn {
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            background: rgba(255, 255, 153, 0.9);
        }

        #angry-btn {
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(255, 153, 153, 0.9);
        }

        #message-box {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            line-height: 1.5;
            z-index: 2000;
            text-align: center;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }
    </style>
    <script>
        // --- çŠ¶æ…‹ç®¡ç†ç”¨å¤‰æ•° ---
        let lastProcessedTimestamp = 0;

        // --- ã‚·ãƒ¼ãƒ³åˆæœŸåŒ–æ™‚ã®å‡¦ç† ---
        document.addEventListener('DOMContentLoaded', function () {
            const scene = document.querySelector('a-scene');

            scene.addEventListener('loaded', () => {
                const happyModel = document.querySelector('#happy-model');
                const angryModel = document.querySelector('#angry-model');

                // ãƒ¢ãƒ‡ãƒ«åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
                function showModel(emotion) {
                    if (emotion === 'happy') {
                        console.log("Showing Happy Model");
                        happyModel.setAttribute('visible', true);
                        angryModel.setAttribute('visible', false);
                    } else if (emotion === 'angry') {
                        console.log("Showing Angry Model");
                        happyModel.setAttribute('visible', false);
                        angryModel.setAttribute('visible', true);
                    }
                }

                // å–œã³è¡¨ç¾
                document.getElementById('happy-btn').addEventListener('click', function () {
                    showModel('happy');
                });

                // æ€’ã‚Šè¡¨ç¾
                document.getElementById('angry-btn').addEventListener('click', function () {
                    showModel('angry');
                });

                // --- APIè¨­å®š ---
                let API_ENDPOINT = '';
                const USER_ID = 'user_A';

                // è¨­å®šã‚’èª­ã¿è¾¼ã‚€
                async function loadConfig() {
                    try {
                        const response = await fetch('./amplify_outputs.json');
                        const config = await response.json();
                        if (config.custom && config.custom.API) {
                            const apiName = Object.keys(config.custom.API)[0];
                            API_ENDPOINT = config.custom.API[apiName].endpoint;
                            console.log('API Endpoint loaded:', API_ENDPOINT);
                        } else {
                            console.warn('API configuration not found in amplify_outputs.json');
                        }
                    } catch (error) {
                        console.error('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }

                loadConfig();

                // --- DBã‹ã‚‰æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•° ---
                async function checkEmotionData() {
                    if (!API_ENDPOINT) return;

                    try {
                        // API Gatewayã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        const response = await fetch(`${API_ENDPOINT}/data?userId=${USER_ID}`);
                        const data = await response.json();

                        // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã®ã¿å‡¦ç†
                        if (data.timestamp && data.timestamp > lastProcessedTimestamp) {
                            lastProcessedTimestamp = data.timestamp;
                            console.log('æ–°ã—ã„æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿:', data.emotion);

                            // æ„Ÿæƒ…ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆã¾ãŸã¯ç›´æ¥é–¢æ•°å‘¼ã³å‡ºã—ï¼‰
                            switch (data.emotion) {
                                case 'happy':
                                    showModel('happy');
                                    break;
                                case 'angry':
                                    showModel('angry');
                                    break;
                            }
                        }
                    } catch (error) {
                        console.error('æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }

                // 1ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
                setInterval(checkEmotionData, 1000);
                console.log('æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã®ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
            });
        });
    </script>
</head>

<body style="margin: 0; overflow: hidden;">
    <!-- UIãƒœã‚¿ãƒ³ -->
    <button id="happy-btn" class="ui-button">ğŸ˜Š å–œã³</button>
    <button id="angry-btn" class="ui-button">ğŸ˜  æ€’ã‚Š</button>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ -->
    <div id="message-box">
        ãŠé‡èœã®å±Šãã¤ã¤å¾…ã¡ãã ã•ã„ã€‚ã©ã‚“ã©ã“ã„ã§ã™ï¼
    </div>

    <a-scene embedded arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'>

        <a-assets>
            <a-asset-item id="happy-asset" src="Animation_Happy_Sway_Standing_withSkin.glb"></a-asset-item>
            <a-asset-item id="angry-asset" src="Animation_Angry_To_Tantrum_Sit_withSkin.glb"></a-asset-item>
        </a-assets>

        <!-- Custom Marker -->
        <a-marker type='pattern' url='pattern-WBF.patt?v=3'>

            <a-entity id="model-container">
                <!-- Happy Model (Default Visible) -->
                <a-gltf-model id="happy-model" src="#happy-asset" position="0 0 0" rotation="0 0 0" scale="1 1 1"
                    animation-mixer visible="true">
                </a-gltf-model>

                <!-- Angry Model (Hidden) -->
                <a-gltf-model id="angry-model" src="#angry-asset" position="0 0 0" rotation="0 0 0" scale="1 1 1"
                    animation-mixer visible="false">
                </a-gltf-model>
            </a-entity>

        </a-marker>

        <a-entity camera></a-entity>

    </a-scene>
</body>

</html>