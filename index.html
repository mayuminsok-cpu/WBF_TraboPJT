<!DOCTYPE html>
<html>

<head>
    <title>Marker-based Animal AR - Emotion Switch</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <style>
        .ui-button {
            position: absolute;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #333;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .ui-button:active {
            transform: scale(0.95);
            background: rgba(200, 200, 200, 0.9);
        }

        #happy-btn {
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            background: rgba(255, 255, 153, 0.9);
        }

        #angry-btn {
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(255, 153, 153, 0.9);
        }

        #connect-btn {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(173, 216, 230, 0.9);
            /* Light Blue */
        }

        #status {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            pointer-events: none;
        }

        #message-box {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            line-height: 1.5;
            z-index: 2000;
            text-align: center;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }
    </style>
    <script>
        // --- Áä∂ÊÖãÁÆ°ÁêÜÁî®Â§âÊï∞ ---
        let lastProcessedTimestamp = 0;

        // --- Èü≥Â£∞AIÁµ±ÂêàÁî®Â§âÊï∞ ---
        const SERVER_URL = "wss://YOUR_NGROK_URL/ws"; // „Ç´„É°„É©ÂÅ¥„Å®Âêå„Åòngrok URL
        const TOKEN = "YOUR_TOKEN";                   // .env„ÅßË®≠ÂÆö„Åó„ÅüÂÖ±ÈÄö„Éà„Éº„ÇØ„É≥

        let socket = null;
        let audioContext = null;
        let nextStartTime = 0;

        // --- „Ç∑„Éº„É≥ÂàùÊúüÂåñÊôÇ„ÅÆÂá¶ÁêÜ ---
        document.addEventListener('DOMContentLoaded', function () {
            const scene = document.querySelector('a-scene');

            // Èü≥Â£∞Êé•Á∂ö„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            document.getElementById('connect-btn').onclick = async () => {
                await initAudio();
                connectWebSocket();
            };

            scene.addEventListener('loaded', () => {
                const happyModel = document.querySelector('#happy-model');
                const angryModel = document.querySelector('#angry-model');

                // „É¢„Éá„É´Âàá„ÇäÊõø„ÅàÈñ¢Êï∞
                function showModel(emotion) {
                    if (emotion === 'happy') {
                        console.log("Showing Happy Model");
                        happyModel.setAttribute('visible', true);
                        angryModel.setAttribute('visible', false);
                    } else if (emotion === 'angry') {
                        console.log("Showing Angry Model");
                        happyModel.setAttribute('visible', false);
                        angryModel.setAttribute('visible', true);
                    }
                }

                // Âñú„Å≥Ë°®Áèæ
                document.getElementById('happy-btn').addEventListener('click', function () {
                    showModel('happy');
                });

                // ÊÄí„ÇäË°®Áèæ
                document.getElementById('angry-btn').addEventListener('click', function () {
                    showModel('angry');
                });

                // --- APIË®≠ÂÆö ---
                let API_ENDPOINT = '';
                const USER_ID = 'user_A';

                // Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„ÇÄ
                async function loadConfig() {
                    try {
                        const response = await fetch('./amplify_outputs.json');
                        const config = await response.json();
                        if (config.custom && config.custom.API) {
                            const apiName = Object.keys(config.custom.API)[0];
                            API_ENDPOINT = config.custom.API[apiName].endpoint;
                            console.log('API Endpoint loaded:', API_ENDPOINT);
                        } else {
                            console.warn('API configuration not found in amplify_outputs.json');
                        }
                    } catch (error) {
                        console.error('Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    }
                }

                loadConfig();

                // --- DB„Åã„ÇâÊÑüÊÉÖ„Éá„Éº„Çø„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞ ---
                async function checkEmotionData() {
                    if (!API_ENDPOINT) return;

                    try {
                        // API Gateway„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó
                        const response = await fetch(`${API_ENDPOINT}/data?userId=${USER_ID}`);
                        const data = await response.json();

                        // Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„ÅÆÂ†¥Âêà„ÅÆ„ÅøÂá¶ÁêÜ
                        if (data.timestamp && data.timestamp > lastProcessedTimestamp) {
                            lastProcessedTimestamp = data.timestamp;
                            console.log('Êñ∞„Åó„ÅÑÊÑüÊÉÖ„Éá„Éº„Çø:', data.emotion);

                            // ÊÑüÊÉÖ„Å´Âøú„Åò„Å¶„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØÔºà„Åæ„Åü„ÅØÁõ¥Êé•Èñ¢Êï∞Âëº„Å≥Âá∫„ÅóÔºâ
                            switch (data.emotion) {
                                case 'happy':
                                    showModel('happy');
                                    break;
                                case 'angry':
                                    showModel('angry');
                                    break;
                            }
                        }
                    } catch (error) {
                        console.error('ÊÑüÊÉÖ„Éá„Éº„Çø„ÅÆÂèñÂæó„Ç®„É©„Éº:', error);
                    }
                }

                // 1Áßí„Åî„Å®„Å´„ÉÅ„Çß„ÉÉ„ÇØ
                setInterval(checkEmotionData, 1000);
                console.log('ÊÑüÊÉÖ„Éá„Éº„Çø„ÅÆÁõ£Ë¶ñ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü');
            });
        });

        // ==========================================
        // 3. Èü≥Â£∞Âá¶ÁêÜ„ÅÆÂàùÊúüÂåñ (24kHz)
        // ==========================================
        async function initAudio() {
            // OpenAI Realtime API„Å´Âêà„Çè„Åõ„Å¶ 24kHz „Åß„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí‰ΩúÊàê
            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });

            // „Éû„Ç§„ÇØÂÖ•Âäõ„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioContext.createMediaStreamSource(stream);

                // PCM16Â§âÊèõÁî®„Éó„É≠„Çª„ÉÉ„Çµ
                const processor = audioContext.createScriptProcessor(4096, 1, 1);

                source.connect(processor);
                processor.connect(audioContext.destination);

                processor.onaudioprocess = (e) => {
                    if (!socket || socket.readyState !== WebSocket.OPEN) return;

                    const inputData = e.inputBuffer.getChannelData(0);
                    // Float32 -> Int16 (PCM) Â§âÊèõ
                    const pcmData = floatTo16BitPCM(inputData);
                    // Base64Â§âÊèõ
                    const base64Audio = arrayBufferToBase64(pcmData);

                    // „Çµ„Éº„Éê„Éº„Å∏ÈÄÅ‰ø°
                    socket.send(JSON.stringify({
                        type: "input_audio_buffer.append",
                        audio: base64Audio
                    }));
                };
            } catch (err) {
                console.error("„Éû„Ç§„ÇØË®±ÂèØ„Ç®„É©„Éº:", err);
                alert("„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            }
        }

        // ==========================================
        // 4. WebSocketÊé•Á∂ö
        // ==========================================
        function connectWebSocket() {
            const url = `${SERVER_URL}?role=ar&token=${TOKEN}`;
            socket = new WebSocket(url);

            socket.onopen = () => {
                document.getElementById('status').innerText = "Êé•Á∂ö‰∏≠ (role=ar)";
                console.log("Connected to Server");
            };

            socket.onmessage = async (event) => {
                const data = JSON.parse(event.data);

                // Èü≥Â£∞„Éá„Éº„ÇøÂèó‰ø° (response.audio.delta)
                if (data.type === "response.audio.delta") {
                    playAudio(data.delta);
                }
            };

            socket.onclose = () => {
                document.getElementById('status').innerText = "ÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü";
            };
        }

        // ==========================================
        // 5. Èü≥Â£∞ÂÜçÁîü (Base64 -> Audio)
        // ==========================================
        function playAudio(base64Data) {
            const binaryString = atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const int16Data = new Int16Array(bytes.buffer);
            const floatData = new Float32Array(int16Data.length);

            // Int16 -> Float32 Â§âÊèõ
            for (let i = 0; i < int16Data.length; i++) {
                floatData[i] = int16Data[i] / 32768.0;
            }

            // „Éê„ÉÉ„Éï„Ç°‰ΩúÊàê
            const buffer = audioContext.createBuffer(1, floatData.length, 24000);
            buffer.getChannelData(0).set(floatData);

            // ÂÜçÁîü„Ç≠„É•„Éº„Ç§„É≥„Ç∞ÔºàÈÄîÂàá„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´ÊôÇÈñì„ÇíÁÆ°ÁêÜÔºâ
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);

            const currentTime = audioContext.currentTime;
            if (nextStartTime < currentTime) {
                nextStartTime = currentTime;
            }
            source.start(nextStartTime);
            nextStartTime += buffer.duration;
        }

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£: Float32 -> Int16
        function floatTo16BitPCM(input) {
            const output = new Int16Array(input.length);
            for (let i = 0; i < input.length; i++) {
                let s = Math.max(-1, Math.min(1, input[i]));
                output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            return output.buffer;
        }

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£: ArrayBuffer -> Base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
    </script>
</head>

<body style="margin: 0; overflow: hidden;">
    <!-- UI„Éú„Çø„É≥ -->
    <button id="connect-btn" class="ui-button">üé§ Èü≥Â£∞Êé•Á∂öÈñãÂßã</button>
    <div id="status">Êú™Êé•Á∂ö</div>

    <button id="happy-btn" class="ui-button">üòä Âñú„Å≥</button>
    <button id="angry-btn" class="ui-button">üò† ÊÄí„Çä</button>

    <!-- „É°„ÉÉ„Çª„Éº„Ç∏„Éú„ÉÉ„ÇØ„Çπ -->
    <div id="message-box">
        „ÅäÈáéËèú„ÅÆÂ±ä„Åç„Å§„Å§ÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ„Å©„Çì„Å©„Åì„ÅÑ„Åß„ÅôÔºÅ
    </div>

    <a-scene embedded arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'>

        <a-assets>
            <a-asset-item id="happy-asset" src="Animation_Happy_Sway_Standing_withSkin.glb"></a-asset-item>
            <a-asset-item id="angry-asset" src="Animation_Angry_To_Tantrum_Sit_withSkin.glb"></a-asset-item>
        </a-assets>

        <!-- Custom Marker -->
        <a-marker type='pattern' url='pattern-WBF.patt?v=3'>

            <a-entity id="model-container">
                <!-- Happy Model (Default Visible) -->
                <a-gltf-model id="happy-model" src="#happy-asset" position="0 0 0" rotation="0 0 0" scale="1 1 1"
                    animation-mixer visible="true">
                </a-gltf-model>

                <!-- Angry Model (Hidden) -->
                <a-gltf-model id="angry-model" src="#angry-asset" position="0 0 0" rotation="0 0 0" scale="1 1 1"
                    animation-mixer visible="false">
                </a-gltf-model>
            </a-entity>

        </a-marker>

        <a-entity camera></a-entity>

    </a-scene>
</body>

</html>