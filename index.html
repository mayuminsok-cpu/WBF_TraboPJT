<!DOCTYPE html>
<html>

<head>
    <title>Marker-based Animal AR - Emotion Switch</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <style>
        .ui-button {
            position: absolute;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #333;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .ui-button:active {
            transform: scale(0.95);
            background: rgba(200, 200, 200, 0.9);
        }

        #happy-btn {
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            background: rgba(255, 255, 153, 0.9);
        }

        #angry-btn {
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(255, 153, 153, 0.9);
        }

        #connect-btn {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(173, 216, 230, 0.9);
            /* Light Blue */
        }

        #status {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            pointer-events: none;
        }

        #message-box {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            line-height: 1.5;
            z-index: 2000;
            text-align: center;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }

        // --- ã‚·ãƒ¼ãƒ³åˆæœŸåŒ–æ™‚ã®å‡¦ç† ---
        document.addEventListener('DOMContentLoaded', function () {
                const scene=document.querySelector('a-scene');

                // éŸ³å£°æ¥ç¶šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                document.getElementById('connect-btn').onclick=async ()=> {
                    await initAudio();
                    connectWebSocket();
                }

                ;

                scene.addEventListener('loaded', ()=> {
                        const happyModel=document.querySelector('#happy-model');
                        const angryModel=document.querySelector('#angry-model');

                        // ãƒ¢ãƒ‡ãƒ«åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
                        function showModel(emotion) {
                            if (emotion==='happy') {
                                console.log("Showing Happy Model");
                                happyModel.setAttribute('visible', true);
                                angryModel.setAttribute('visible', false);
                            }

                            else if (emotion==='angry') {
                                console.log("Showing Angry Model");
                                happyModel.setAttribute('visible', false);
                                angryModel.setAttribute('visible', true);
                            }
                        }

                        // å–œã³è¡¨ç¾
                        document.getElementById('happy-btn').addEventListener('click', function () {
                                showModel('happy');
                            });

                        // æ€’ã‚Šè¡¨ç¾
                        document.getElementById('angry-btn').addEventListener('click', function () {
                                showModel('angry');
                            });

                        // --- APIè¨­å®š ---
                        let API_ENDPOINT='';
                        const USER_ID='user_A';

                        // è¨­å®šã‚’èª­ã¿è¾¼ã‚€
                        async function loadConfig() {
                            try {
                                const response=await fetch('./amplify_outputs.json');
                                const config=await response.json();

                                if (config.custom && config.custom.API) {
                                    const apiName=Object.keys(config.custom.API)[0];
                                    API_ENDPOINT=config.custom.API[apiName].endpoint;
                                    console.log('API Endpoint loaded:', API_ENDPOINT);
                                }

                                else {
                                    console.warn('API configuration not found in amplify_outputs.json');
                                }
                            }

                            catch (error) {
                                console.error('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                            }
                        }

                        loadConfig();

                        // --- DBã‹ã‚‰æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•° ---
                        async function checkEmotionData() {
                            if ( !API_ENDPOINT) return;

                            try {

                                // API Gatewayã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                                const response=await fetch(`$ {
                                        API_ENDPOINT
                                    }

                                    /data?userId=$ {
                                        USER_ID
                                    }

                                    `);
                                const data=await response.json();

                                // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã®ã¿å‡¦ç†
                                if (data.timestamp && data.timestamp > lastProcessedTimestamp) {
                                    lastProcessedTimestamp=data.timestamp;
                                    console.log('æ–°ã—ã„æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿:', data.emotion);

                                    // æ„Ÿæƒ…ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆã¾ãŸã¯ç›´æ¥é–¢æ•°å‘¼ã³å‡ºã—ï¼‰
                                    switch (data.emotion) {
                                        case 'happy': showModel('happy');
                                        break;
                                        case 'angry': showModel('angry');
                                        break;
                                    }
                                }
                            }

                            catch (error) {
                                console.error('æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                            }
                        }

                        // 1ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
                        setInterval(checkEmotionData, 1000);
                        console.log('æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã®ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
                    });
            });

        // ==========================================
        // 3. éŸ³å£°å‡¦ç†ã®åˆæœŸåŒ– (24kHz)
        // ==========================================
        async function initAudio() {

            // OpenAI Realtime APIã«åˆã‚ã›ã¦ 24kHz ã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
            audioContext=new (window.AudioContext || window.webkitAudioContext)({
                sampleRate: 24000
            });

        // ãƒã‚¤ã‚¯å…¥åŠ›ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        try {
            const stream=await navigator.mediaDevices.getUserMedia({
                audio: true
            });
        const source=audioContext.createMediaStreamSource(stream);

        // PCM16å¤‰æ›ç”¨ãƒ—ãƒ­ã‚»ãƒƒã‚µ
        const processor=audioContext.createScriptProcessor(4096, 1, 1);

        source.connect(processor);
        processor.connect(audioContext.destination);

        processor.onaudioprocess=(e)=> {
            if ( !socket || socket.readyState !==WebSocket.OPEN) return;

            const inputData=e.inputBuffer.getChannelData(0);
            // Float32 -> Int16 (PCM) å¤‰æ›
            const pcmData=floatTo16BitPCM(inputData);
            // Base64å¤‰æ›
            const base64Audio=arrayBufferToBase64(pcmData);

            // ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡
            socket.send(JSON.stringify({
                    type: "input_audio_buffer.append",
                    audio: base64Audio
                }));
        }

        ;
        }

        catch (err) {
            console.error("ãƒã‚¤ã‚¯è¨±å¯ã‚¨ãƒ©ãƒ¼:", err);
            alert("ãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„");
        }
        }

        // ==========================================
        // 4. WebSocketæ¥ç¶š
        // ==========================================
        function connectWebSocket() {
            const url=`$ {
                SERVER_URL
            }

            ?role=ar&token=$ {
                TOKEN
            }

            `;
            socket=new WebSocket(url);

            socket.onopen=()=> {
                document.getElementById('status').innerText="æ¥ç¶šä¸­ (role=ar)";
                console.log("Connected to Server");
            }

            ;

            socket.onmessage=async (event)=> {
                const data=JSON.parse(event.data);

                // éŸ³å£°ãƒ‡ãƒ¼ã‚¿å—ä¿¡ (response.audio.delta)
                if (data.type==="response.audio.delta") {
                    playAudio(data.delta);
                }
            }

            ;

            socket.onclose=()=> {
                document.getElementById('status').innerText="åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ";
            }

            ;
        }

        // ==========================================
        // 5. éŸ³å£°å†ç”Ÿ (Base64 -> Audio)
        // ==========================================
        function playAudio(base64Data) {
            const binaryString=atob(base64Data);
            const len=binaryString.length;
            const bytes=new Uint8Array(len);

            for (let i=0; i < len; i++) {
                bytes[i]=binaryString.charCodeAt(i);
            }

            const int16Data=new Int16Array(bytes.buffer);
            const floatData=new Float32Array(int16Data.length);

            // Int16 -> Float32 å¤‰æ›
            for (let i=0; i < int16Data.length; i++) {
                floatData[i]=int16Data[i] / 32768.0;
            }

            // ãƒãƒƒãƒ•ã‚¡ä½œæˆ
            const buffer=audioContext.createBuffer(1, floatData.length, 24000);
            buffer.getChannelData(0).set(floatData);

            // å†ç”Ÿã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ï¼ˆé€”åˆ‡ã‚Œãªã„ã‚ˆã†ã«æ™‚é–“ã‚’ç®¡ç†ï¼‰
            const source=audioContext.createBufferSource();
            source.buffer=buffer;
            source.connect(audioContext.destination);

            const currentTime=audioContext.currentTime;

            if (nextStartTime < currentTime) {
                nextStartTime=currentTime;
            }

            source.start(nextStartTime);
            nextStartTime+=buffer.duration;
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: Float32 -> Int16
        function floatTo16BitPCM(input) {
            const output=new Int16Array(input.length);

            for (let i=0; i < input.length; i++) {
                let s=Math.max(-1, Math.min(1, input[i]));
                output[i]=s < 0 ? s * 0x8000: s * 0x7FFF;
            }

            return output.buffer;
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ArrayBuffer -> Base64
        function arrayBufferToBase64(buffer) {
            let binary='';
            const bytes=new Uint8Array(buffer);
            const len=bytes.byteLength;

            for (let i=0; i < len; i++) {
                binary+=String.fromCharCode(bytes[i]);
            }

            return window.btoa(binary);
        }

        </script></head><body style="margin: 0; overflow: hidden;">< !-- UIãƒœã‚¿ãƒ³ --><button id="connect-btn" class="ui-button">ğŸ¤ éŸ³å£°æ¥ç¶šé–‹å§‹</button><div id="status">æœªæ¥ç¶š</div><button id="happy-btn" class="ui-button">ğŸ˜Š å–œã³</button><button id="angry-btn" class="ui-button">ğŸ˜  æ€’ã‚Š</button>< !-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ --><div id="message-box">ãŠé‡èœã®å±Šãã¤ã¤å¾…ã¡ãã ã•ã„ã€‚ã©ã‚“ã©ã“ã„ã§ã™ï¼ </div><a-scene embedded arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'><a-assets><a-asset-item id="happy-asset" src="Animation_Happy_Sway_Standing_withSkin.glb"></a-asset-item><a-asset-item id="angry-asset" src="Animation_Angry_To_Tantrum_Sit_withSkin.glb"></a-asset-item></a-assets>< !-- Custom Marker --><a-marker type='pattern' url='pattern-WBF.patt?v=3'><a-entity id="model-container">< !-- Happy Model (Default Visible) --><a-gltf-model id="happy-model" src="#happy-asset" position="0 0 0" rotation="0 0 0" scale="1 1 1"
        animation-mixer visible="true"></a-gltf-model>< !-- Angry Model (Hidden) --><a-gltf-model id="angry-model" src="#angry-asset" position="0 0 0" rotation="0 0 0" scale="1 1 1"
        animation-mixer visible="false"></a-gltf-model></a-entity></a-marker><a-entity camera></a-entity></a-scene></body></html>