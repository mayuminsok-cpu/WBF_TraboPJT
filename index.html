<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Marker-based Animal AR - Emotion Switch</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <!-- Particle system removed due to compatibility issues -->
    <style>
        .ui-button {
            position: absolute;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #333;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .ui-button:active {
            transform: scale(0.95);
            background: rgba(200, 200, 200, 0.9);
        }

        #happy-btn {
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            background: rgba(255, 255, 153, 0.9);
        }

        #angry-btn {
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(255, 153, 153, 0.9);
        }

        #connect-btn {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(173, 216, 230, 0.9);
        }

        #summon-btn {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 215, 0, 0.9);
            /* Gold */
            color: black;
            font-size: 24px;
            padding: 20px 40px;
            border: 3px solid #fff;
            display: none;
            /* Initially hidden */
            z-index: 2000;
        }

        #status {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            pointer-events: none;
        }

        #message-box {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            line-height: 1.5;
            z-index: 2000;
            text-align: center;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* Emotion Icon Overlay */
        .emotion-icon-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1500;
            display: none;
        }

        .emotion-icon {
            position: absolute;
            font-size: 40px;
            animation: float 3s ease-in-out;
            opacity: 0;
        }

        @keyframes float {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0.5);
            }

            50% {
                opacity: 1;
                transform: translateY(-20px) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-40px) scale(0.8);
            }
        }
    </style>
    <script>
        // --- Áä∂ÊÖãÁÆ°ÁêÜÁî®Â§âÊï∞ ---
        let lastProcessedTimestamp = "";

        // --- Èü≥Â£∞AIÁµ±ÂêàÁî®Â§âÊï∞ ---
        const SERVER_URL = "wss://chase-unpatient-denice.ngrok-free.dev/ws";
        const TOKEN = "my_secret_token_123";

        let socket = null;
        let audioContext = null;
        let nextStartTime = 0;

        // --- „Ç∑„Éº„É≥ÂàùÊúüÂåñÊôÇ„ÅÆÂá¶ÁêÜ ---
        document.addEventListener('DOMContentLoaded', function () {
            const scene = document.querySelector('a-scene');

            // Èü≥Â£∞Êé•Á∂ö„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            document.getElementById('connect-btn').onclick = async () => {
                await initAudio();
                connectWebSocket();
            };

            if (scene) {
                scene.addEventListener('loaded', () => {
                    // --- „É¢„Éá„É´ÂèÇÁÖß ---
                    const joyfulModel = document.querySelector('#joyful-model');
                    const happy1Model = document.querySelector('#happy-1-model');
                    const happy2Model = document.querySelector('#happy-2-model');
                    const happy3Model = document.querySelector('#happy-3-model');
                    const angryModel = document.querySelector('#angry-model');
                    const angerIcon = document.querySelector('#anger-icon');
                    const heartIcon = document.querySelector('#heart-icon');

                    // ÂÖ®„É¢„Éá„É´„ÅÆÈÖçÂàó
                    const allModels = [joyfulModel, happy1Model, happy2Model, happy3Model, angryModel];

                    // --- Âè¨Âñö„É≠„Ç∏„ÉÉ„ÇØÂ§âÊï∞ ---
                    const summonBtn = document.getElementById('summon-btn');
                    const wbfMarker = document.querySelector('a-marker[url*="pattern-WBF"]');
                    const hiroMarker = document.querySelector('a-marker[preset="hiro"]');
                    const buddyModel = document.querySelector('a-marker[preset="hiro"] > a-gltf-model');

                    // Âè¨ÂñöÁä∂ÊÖã„Éï„É©„Ç∞
                    let isSummoned = false;
                    let hasChangedToRecycleBuddy = false; // „É¢„Éá„É´„ÉÅ„Çß„É≥„Ç∏Ê∏à„Åø„Éï„É©„Ç∞
                    let recycleBuddyModel = null; // WBF„Éû„Éº„Ç´„Éº‰∏ä„ÅÆRecycle Buddy„É¢„Éá„É´
                    let currentEmotion = null; // ÁèæÂú®„ÅÆ„Ç®„É¢„Éº„Ç∑„Éß„É≥
                    let emotionTimeout = null; // „Ç®„É¢„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„Éà



                    // --- ÂÖ®„É¢„Éá„É´„ÇíÈùûË°®Á§∫„Å´„Åô„ÇãÈñ¢Êï∞ ---
                    function hideAllModels() {
                        allModels.forEach(model => {
                            if (model) model.setAttribute('visible', false);
                        });
                        // ARÁ©∫Èñì„ÅÆ„Ç¢„Ç§„Ç≥„É≥„ÇíÈùûË°®Á§∫ÔºàÂâäÈô§‰∫àÂÆöÔºâ
                        if (angerIcon) angerIcon.setAttribute('visible', false);
                        if (heartIcon) heartIcon.setAttribute('visible', false);
                        // ÁîªÈù¢Âõ∫ÂÆö„ÅÆ„Ç¢„Ç§„Ç≥„É≥„ÇíÈùûË°®Á§∫
                        hideEmotionIcons();
                    }

                    // --- ÁîªÈù¢Âõ∫ÂÆö„ÅÆÊÑüÊÉÖ„Ç¢„Ç§„Ç≥„É≥„ÇíË°®Á§∫ ---
                    function showEmotionIcons(emotion) {
                        const overlay = document.getElementById('emotion-overlay');
                        overlay.style.display = 'block';
                        overlay.innerHTML = ''; // „ÇØ„É™„Ç¢

                        const icon = emotion === 'happy' ? '‚ù§' : (emotion === 'celebrate' ? 'üéâ' : 'üí¢');
                        const iconCount = 8; // „Ç¢„Ç§„Ç≥„É≥„ÅÆÊï∞

                        for (let i = 0; i < iconCount; i++) {
                            const iconElement = document.createElement('div');
                            iconElement.className = 'emotion-icon';
                            iconElement.textContent = icon;

                            // „Éè„Éº„Éà„ÅÆÂ†¥Âêà„ÅØ„Éî„É≥„ÇØËâ≤„Å´„ÄÅÁ•ù„ÅÑ„ÅÆÂ†¥Âêà„ÅØÈáëËâ≤„Å´
                            if (emotion === 'happy') {
                                iconElement.style.color = '#FF69B4'; // „Éõ„ÉÉ„Éà„Éî„É≥„ÇØ
                            } else if (emotion === 'celebrate') {
                                iconElement.style.color = '#FFD700'; // „Ç¥„Éº„É´„Éâ
                            }

                            // „É©„É≥„ÉÄ„É†„Å™‰ΩçÁΩÆ„Å´ÈÖçÁΩÆ
                            iconElement.style.left = `${Math.random() * 80 + 10}%`;
                            iconElement.style.top = `${Math.random() * 70 + 15}%`;
                            iconElement.style.animationDelay = `${Math.random() * 0.5}s`;

                            overlay.appendChild(iconElement);
                        }

                        // 3ÁßíÂæå„Å´ÈùûË°®Á§∫
                        setTimeout(() => {
                            hideEmotionIcons();
                        }, 3000);
                    }

                    // --- ÁîªÈù¢Âõ∫ÂÆö„ÅÆÊÑüÊÉÖ„Ç¢„Ç§„Ç≥„É≥„ÇíÈùûË°®Á§∫ ---
                    function hideEmotionIcons() {
                        const overlay = document.getElementById('emotion-overlay');
                        overlay.style.display = 'none';
                        overlay.innerHTML = '';
                    }

                    // --- JoyfulÔºàÂæÖÊ©üÁä∂ÊÖãÔºâ„ÇíË°®Á§∫ ---
                    function showJoyful() {
                        if (!isSummoned) return;
                        if (hasChangedToRecycleBuddy) return;
                        hideAllModels();
                        joyfulModel.setAttribute('visible', true);
                        console.log("Showing Joyful (Idle) Model");
                    }

                    // --- „É¢„Éá„É´Âàá„ÇäÊõø„ÅàÈñ¢Êï∞Ôºà„É©„É≥„ÉÄ„É†ÈÅ∏ÊäûÔºâ ---
                    function showModel(emotion) {
                        console.log(`showModel called with: ${emotion}. isSummoned: ${isSummoned}, hasChangedToRecycleBuddy: ${hasChangedToRecycleBuddy}`);
                        if (!isSummoned) return;
                        // „É¢„Éá„É´„ÉÅ„Çß„É≥„Ç∏Ê∏à„Åø„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
                        if (hasChangedToRecycleBuddy) {
                            console.log('Skipping showModel because Recycle Buddy is active.');
                            return;
                        }

                        // Êó¢Â≠ò„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Çí„ÇØ„É™„Ç¢
                        if (emotionTimeout) {
                            clearTimeout(emotionTimeout);
                            emotionTimeout = null;
                        }

                        hideAllModels();
                        currentEmotion = emotion;

                        if (emotion === 'happy') {
                            // „É©„É≥„ÉÄ„É†„ÅßHappy1, 2, 3„ÇíÈÅ∏Êäû
                            const rand = Math.random();
                            let randomHappy;
                            if (rand < 0.33) randomHappy = happy1Model;
                            else if (rand < 0.66) randomHappy = happy2Model;
                            else randomHappy = happy3Model;

                            randomHappy.setAttribute('visible', true);

                            // ÁîªÈù¢Âõ∫ÂÆö„ÅÆ„Éè„Éº„Éà„Ç¢„Ç§„Ç≥„É≥„ÇíË°®Á§∫
                            showEmotionIcons('happy');

                            console.log(`Showing Happy Model: ${randomHappy.id}`);

                            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´Joyful„Å´Êàª„Çã
                            emotionTimeout = setTimeout(() => {
                                showJoyful();
                            }, 3000); // 3ÁßíÂæåÔºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÊôÇÈñì„Å´Âøú„Åò„Å¶Ë™øÊï¥Ôºâ

                        } else if (emotion === 'angry') {
                            // Angry„ÅØ1„Å§
                            angryModel.setAttribute('visible', true);

                            // ÁîªÈù¢Âõ∫ÂÆö„ÅÆÊÄí„Çä„Ç¢„Ç§„Ç≥„É≥„ÇíË°®Á§∫
                            showEmotionIcons('angry');

                            console.log(`Showing Angry Model: ${angryModel.id}`);

                            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´Joyful„Å´Êàª„ÇãÔºà„Ç¢„Ç§„Ç≥„É≥„ÇÇÈùûË°®Á§∫Ôºâ
                            emotionTimeout = setTimeout(() => {
                                showJoyful();
                            }, 3000); // 3ÁßíÂæåÔºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÊôÇÈñì„Å´Âøú„Åò„Å¶Ë™øÊï¥Ôºâ
                        }
                    }

                    // Âñú„Å≥Ë°®ÁèæÔºàÊâãÂãï„Éú„Çø„É≥Ôºâ
                    document.getElementById('happy-btn').addEventListener('click', function () {
                        // Âè¨Âñö„Åï„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞Ëá™ÂãïÂè¨Âñö
                        if (!isSummoned) {
                            isSummoned = true;
                            summonBtn.style.display = 'none';
                        }
                        showModel('happy');
                    });

                    // ÊÄí„ÇäË°®ÁèæÔºàÊâãÂãï„Éú„Çø„É≥Ôºâ
                    document.getElementById('angry-btn').addEventListener('click', function () {
                        // Âè¨Âñö„Åï„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞Ëá™ÂãïÂè¨Âñö
                        if (!isSummoned) {
                            isSummoned = true;
                            summonBtn.style.display = 'none';
                        }
                        showModel('angry');
                    });

                    // --- „Ç∑„É≥„Éó„É´„Å™„Ç®„Éï„Çß„ÇØ„ÉàÈñ¢Êï∞ ---
                    function showEffect(markerElement) {
                        console.log('‚ú® Effect triggered!');
                        // Á∞°ÊòìÁöÑ„Å™„É≠„Ç∞Âá∫Âäõ„ÅÆ„ÅøÔºà„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅØ‰∫íÊèõÊÄßÂïèÈ°å„ÅÆ„Åü„ÇÅÂâäÈô§Ôºâ
                    }

                    let currentVisibleMarker = null;
                    let currentTargetModel = null;

                    // --- „Éû„Éº„Ç´„ÉºÊ§úÂá∫ÊôÇ„ÅÆÂá¶ÁêÜ ---
                    function handleMarkerFound(marker, model) {
                        currentVisibleMarker = marker;
                        currentTargetModel = model;

                        if (!isSummoned) {
                            // Âè¨ÂñöÂâçÔºö„Éú„Çø„É≥„ÇíË°®Á§∫„ÄÅ„É¢„Éá„É´„ÇíÈö†„Åô
                            summonBtn.style.display = 'block';
                            hideAllModels();
                        } else {
                            // Êó¢„Å´Âè¨ÂñöÊ∏à„Åø„Å™„Çâ„ÄÅJoyful„Åæ„Åü„ÅØÁèæÂú®„ÅÆ„Ç®„É¢„Éº„Ç∑„Éß„É≥„ÇíË°®Á§∫
                            if (marker === wbfMarker) {
                                if (currentEmotion) {
                                    showModel(currentEmotion);
                                } else {
                                    showJoyful();
                                }
                            } else if (currentTargetModel) {
                                currentTargetModel.setAttribute('visible', true);
                            }
                        }
                    }

                    // --- „Éû„Éº„Ç´„Éº„É≠„Çπ„ÉàÊôÇ„ÅÆÂá¶ÁêÜ ---
                    function handleMarkerLost() {
                        summonBtn.style.display = 'none';
                        // isSummoned„ÅØ„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑÔºà‰∏ÄÂ∫¶Âè¨Âñö„Åó„Åü„ÇâÊ¨°Âõû„ÇÇË°®Á§∫Ôºâ

                        // „Ç®„É¢„Éº„Ç∑„Éß„É≥Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„ÉàÔºàÂÜçÊ§úÂá∫ÊôÇ„ÅØÂæÖÊ©üÁä∂ÊÖã„Å´Êàª„ÅôÔºâ
                        currentEmotion = null;

                        // ÂÖ®„É¢„Éá„É´ÈùûË°®Á§∫
                        hideAllModels();
                        if (currentTargetModel) currentTargetModel.setAttribute('visible', false);
                        if (buddyModel) buddyModel.setAttribute('visible', false);

                        currentVisibleMarker = null;
                        currentTargetModel = null;
                        currentParticles = null;
                    }

                    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÁôªÈå≤ („Éû„Éº„Ç´„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø)
                    if (wbfMarker) {
                        wbfMarker.addEventListener('markerFound', () => {
                            handleMarkerFound(wbfMarker, null);
                        });
                        wbfMarker.addEventListener('markerLost', handleMarkerLost);
                    }

                    if (hiroMarker) {
                        hiroMarker.addEventListener('markerFound', () => {
                            handleMarkerFound(hiroMarker, buddyModel);
                        });
                        hiroMarker.addEventListener('markerLost', handleMarkerLost);
                    }

                    // --- Âè¨Âñö„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà ---
                    summonBtn.addEventListener('click', () => {
                        if (currentVisibleMarker) {
                            summonBtn.style.display = 'none';
                            isSummoned = true; // „Éï„É©„Ç∞ON

                            // JoyfulÔºàÂæÖÊ©üÁä∂ÊÖãÔºâ„ÇíË°®Á§∫
                            if (currentVisibleMarker === wbfMarker) {
                                showJoyful();
                            } else if (currentTargetModel) {
                                // Hiro„Éû„Éº„Ç´„Éº„ÅÆÂ†¥Âêà„ÇÇÈùûË°®Á§∫
                                currentTargetModel.setAttribute('visible', false);
                            }

                            console.log('Âè¨ÂñöÂÆå‰∫Ü„ÄÇJoyfulÔºàÂæÖÊ©üÁä∂ÊÖãÔºâ„ÇíË°®Á§∫„ÄÇ„Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆÊõ¥Êñ∞„ÇíÂæÖÊ©ü‰∏≠...');
                        }
                    });

                    // --- APIË®≠ÂÆö ---
                    let API_ENDPOINT = '';
                    const USER_ID = 'webapp_user';

                    // Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„ÇÄ
                    async function loadConfig() {
                        try {
                            const response = await fetch('./amplify_outputs.json');
                            const config = await response.json();
                            if (config.custom && config.custom.API) {
                                const apiName = Object.keys(config.custom.API)[0];
                                API_ENDPOINT = config.custom.API[apiName].endpoint;
                                // Êú´Â∞æ„ÅÆ„Çπ„É©„ÉÉ„Ç∑„É•„ÇíÂâäÈô§
                                if (API_ENDPOINT.endsWith('/')) {
                                    API_ENDPOINT = API_ENDPOINT.slice(0, -1);
                                }
                                console.log('API Endpoint loaded:', API_ENDPOINT);
                            } else {
                                console.warn('API configuration not found in amplify_outputs.json');
                            }
                        } catch (error) {
                            console.error('Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                        }
                    }

                    loadConfig();

                    // --- DB„Åã„ÇâÊÑüÊÉÖ„Éá„Éº„Çø„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞ ---
                    async function checkEmotionData() {
                        if (!isSummoned) return; // Âè¨ÂñöÂâç„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
                        if (!API_ENDPOINT) return;

                        try {
                            // „Ç≠„É£„ÉÉ„Ç∑„É•ÂõûÈÅø„ÅÆ„Åü„ÇÅ„Å´„Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò‰∏é
                            // „Ç≠„É£„ÉÉ„Ç∑„É•ÂõûÈÅø
                            const timestamp = new Date().getTime();
                            const response = await fetch(`${API_ENDPOINT}/data?userId=${USER_ID}&_t=${timestamp}`, {
                                cache: "no-store",
                                headers: {
                                    'Cache-Control': 'no-cache',
                                    'Pragma': 'no-cache'
                                }
                            });
                            const data = await response.json();

                            // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞
                            console.log('Fetched Data:', data);
                            console.log('Timestamp check:', data.timestamp, lastProcessedTimestamp);

                            if (data.timestamp && data.timestamp > lastProcessedTimestamp) {
                                console.log(`New data detected! Timestamp: ${data.timestamp} > ${lastProcessedTimestamp}`);
                                lastProcessedTimestamp = data.timestamp;

                                if (data.has_change === false) {
                                    console.log('has_change is false, ignoring.');
                                    return;
                                }

                                console.log(`Processing emotion. is_valid: ${data.is_valid}, isSummoned: ${isSummoned}`);

                                if (typeof data.is_valid !== 'undefined') {
                                    if (data.is_valid) {
                                        showModel('happy');
                                        // ÈÄ£Á∂öÊàêÂäü„ÉÅ„Çß„ÉÉ„ÇØ
                                        await checkConsecutiveSuccess(data.timestamp);
                                    } else {
                                        showModel('angry');
                                    }
                                } else if (data.emotion) {
                                    showModel(data.emotion);
                                }

                                if (data.message) {
                                    const messageBox = document.getElementById('message-box');
                                    if (messageBox) {
                                        messageBox.innerText = data.message;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('„Éá„Éº„Çø„ÅÆÂèñÂæó„Ç®„É©„Éº:', error);
                        }
                    }

                    // --- ÈÄ£Á∂öÊàêÂäü„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞ ---
                    async function checkConsecutiveSuccess(currentTimestamp) {
                        if (hasChangedToRecycleBuddy) return; // Êó¢„Å´„É¢„Éá„É´„ÉÅ„Çß„É≥„Ç∏Ê∏à„Åø

                        try {
                            // ÊúÄÊñ∞2‰ª∂„ÇíÂèñÂæó
                            // ÊúÄÊñ∞2‰ª∂„ÇíÂèñÂæóÔºà„Ç≠„É£„ÉÉ„Ç∑„É•ÂõûÈÅøÔºâ
                            const timestamp = new Date().getTime();
                            const response = await fetch(`${API_ENDPOINT}/data?userId=${USER_ID}&limit=2&_t=${timestamp}`, {
                                cache: "no-store",
                                headers: {
                                    'Cache-Control': 'no-cache',
                                    'Pragma': 'no-cache'
                                }
                            });
                            const data = await response.json();

                            // „É¨„Çπ„Éù„É≥„Çπ„ÅåÈÖçÂàó„Åã„ÄÅItems„ÇíÊåÅ„Å§„Åã„ÄÅÂçò‰∏Ä„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„ÇíÁ¢∫Ë™ç
                            let records = [];
                            if (Array.isArray(data)) {
                                records = data;
                            } else if (data.Items) {
                                records = data.Items;
                            } else {
                                records = [data];
                            }

                            console.log('Consecutive Check Records:', records);

                            if (records.length >= 2) {
                                const latest = records[0];
                                const previous = records[1];
                                console.log('Latest:', latest.is_valid, latest.timestamp);
                                console.log('Previous:', previous.is_valid, previous.timestamp);

                                // ‰∏°Êñπ„Å®„ÇÇis_valid=true„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                                if (latest.is_valid === true && previous.is_valid === true) {
                                    console.log('ÈÄ£Á∂öÊàêÂäüÊ§úÂá∫ÔºÅ„É¢„Éá„É´„ÉÅ„Çß„É≥„Ç∏„ÇíÂÆüË°å');
                                    triggerModelChange();
                                }
                            }
                        } catch (error) {
                            console.error('ÈÄ£Á∂öÊàêÂäü„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
                        }
                    }

                    // --- „É¢„Éá„É´„ÉÅ„Çß„É≥„Ç∏Èñ¢Êï∞ ---
                    function triggerModelChange() {
                        if (!isSummoned) return;
                        if (hasChangedToRecycleBuddy) return;

                        hasChangedToRecycleBuddy = true;

                        // Happy/Angry„É¢„Éá„É´„ÇíÈùûË°®Á§∫
                        hideAllModels();

                        // WBF„Éû„Éº„Ç´„Éº‰∏ä„Å´Recycle Buddy„Çí‰ΩúÊàê
                        recycleBuddyModel = document.createElement('a-gltf-model');
                        recycleBuddyModel.setAttribute('src', '#buddy-asset');
                        recycleBuddyModel.setAttribute('position', '0 0 0');
                        recycleBuddyModel.setAttribute('rotation', '0 0 0');
                        recycleBuddyModel.setAttribute('scale', '1.5 1.5 1.5');
                        recycleBuddyModel.setAttribute('animation-mixer', 'loop: once');
                        recycleBuddyModel.setAttribute('visible', true);

                        // WBF„Éû„Éº„Ç´„Éº„ÅÆmodel-container„Å´ËøΩÂä†
                        const modelContainer = document.getElementById('model-container');
                        if (modelContainer) {
                            modelContainer.appendChild(recycleBuddyModel);
                        }

                        // „É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞
                        const messageBox = document.getElementById('message-box');
                        if (messageBox) {
                            messageBox.innerText = '„Åô„Åî„ÅÑÔºÅ2ÂõûÈÄ£Á∂öÊàêÂäü„ÇÑÔºÅ„É™„Çµ„Ç§„ÇØ„É´„Éê„Éá„Ç£ÁôªÂ†¥ÔºÅ';
                        }

                        // „ÅäÁ•ù„ÅÑ„Ç®„Éï„Çß„ÇØ„ÉàÔºà„Ç¢„Ç§„Ç≥„É≥Ôºâ
                        showEmotionIcons('celebrate');



                        console.log('„É¢„Éá„É´„ÉÅ„Çß„É≥„Ç∏ÂÆå‰∫Ü: Recycle BuddyË°®Á§∫');
                    }

                    // 1Áßí„Åî„Å®„Å´„ÉÅ„Çß„ÉÉ„ÇØ
                    setInterval(checkEmotionData, 1000);
                    console.log('„Éá„Éº„Çø„ÅÆÁõ£Ë¶ñ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü');
                });
            } else {
                console.error("a-scene not found!");
            }
        });

        // ==========================================
        // Èü≥Â£∞Âá¶ÁêÜÈñ¢Êï∞Áæ§
        // ==========================================
        async function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);

                source.connect(processor);
                processor.connect(audioContext.destination);

                processor.onaudioprocess = (e) => {
                    if (!socket || socket.readyState !== WebSocket.OPEN) return;
                    const inputData = e.inputBuffer.getChannelData(0);
                    const pcmData = floatTo16BitPCM(inputData);
                    const base64Audio = arrayBufferToBase64(pcmData);
                    socket.send(JSON.stringify({
                        type: "input_audio_buffer.append",
                        audio: base64Audio
                    }));
                };
            } catch (err) {
                console.error("„Éû„Ç§„ÇØË®±ÂèØ„Ç®„É©„Éº:", err);
                alert("„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            }
        }

        function connectWebSocket() {
            const url = `${SERVER_URL}?role=ar&token=${TOKEN}`;
            socket = new WebSocket(url);

            socket.onopen = () => {
                document.getElementById('status').innerText = "Êé•Á∂ö‰∏≠ (role=ar)";
                console.log("Connected to Server");
            };

            socket.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                if (data.type === "response.audio.delta") {
                    playAudio(data.delta);
                }
            };

            socket.onclose = () => {
                document.getElementById('status').innerText = "ÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü";
            };
        }

        function playAudio(base64Data) {
            const binaryString = atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const int16Data = new Int16Array(bytes.buffer);
            const floatData = new Float32Array(int16Data.length);

            for (let i = 0; i < int16Data.length; i++) {
                floatData[i] = int16Data[i] / 32768.0;
            }

            const buffer = audioContext.createBuffer(1, floatData.length, 24000);
            buffer.getChannelData(0).set(floatData);

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);

            const currentTime = audioContext.currentTime;
            if (nextStartTime < currentTime) {
                nextStartTime = currentTime;
            }
            source.start(nextStartTime);
            nextStartTime += buffer.duration;
        }

        function floatTo16BitPCM(input) {
            const output = new Int16Array(input.length);
            for (let i = 0; i < input.length; i++) {
                let s = Math.max(-1, Math.min(1, input[i]));
                output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            return output.buffer;
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
    </script>
</head>

<body style="margin: 0; overflow: hidden;">
    <!-- UI„Éú„Çø„É≥ -->
    <button id="connect-btn" class="ui-button">üé§ Èü≥Â£∞Êé•Á∂öÈñãÂßã</button>
    <button id="summon-btn" class="ui-button">‚ú® Âè¨ÂñöÔºÅ ‚ú®</button>
    <div id="status">Êú™Êé•Á∂ö</div>

    <button id="happy-btn" class="ui-button">üòä Âñú„Å≥</button>
    <button id="angry-btn" class="ui-button">üò† ÊÄí„Çä</button>

    <!-- „É°„ÉÉ„Çª„Éº„Ç∏„Éú„ÉÉ„ÇØ„Çπ -->
    <div id="message-box">
        „Ç¥„Éü„ÇíÊç®„Å¶„Å¶„Å≠ÔºÅ
    </div>

    <!-- Emotion Icon Overlay -->
    <div id="emotion-overlay" class="emotion-icon-overlay"></div>

    <a-scene embedded arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'>

        <a-assets>
            <!-- Happy animations (3 variants) -->
            <a-asset-item id="happy-1-asset"
                src="chibi_remake_Animation_Happy_Sway_Standing_withSkin (1).glb"></a-asset-item>
            <a-asset-item id="happy-2-asset"
                src="chibi_remake_Animation_Joyful_Dance_with_Hand_Sway_withSkin.glb"></a-asset-item>
            <a-asset-item id="happy-3-asset" src="chibi_remake_Animation_Excited_Walk_F_withSkin.glb"></a-asset-item>

            <!-- Angry animations (1 variant) -->
            <a-asset-item id="angry-asset"
                src="chibi_remake_Animation_Angry_Ground_Stomp_2_withSkin (1).glb"></a-asset-item>

            <!-- Joyful (idle/waiting state) -->
            <a-asset-item id="joyful-asset" src="chibi_remake_Animation_Idle_4_withSkin.glb"></a-asset-item>

            <!-- Recycle Buddy -->
            <a-asset-item id="buddy-asset" src="Recycle_Buddy_1203165406_texture.glb"></a-asset-item>
        </a-assets>

        <!-- Custom Marker -->
        <a-marker type='pattern' url='pattern-WBF.patt?v=3'>

            <a-entity id="model-container">
                <!-- Joyful (Idle/Waiting State) -->
                <a-gltf-model id="joyful-model" src="#joyful-asset" position="0 0 0" rotation="0 0 0" scale="3 3 3"
                    animation-mixer="loop: repeat" visible="false">
                </a-gltf-model>

                <!-- Happy Models (3 variants) -->
                <a-gltf-model id="happy-1-model" src="#happy-1-asset" position="0 0 0" rotation="0 0 0" scale="3 3 3"
                    animation-mixer="loop: once" visible="false">
                </a-gltf-model>
                <a-gltf-model id="happy-2-model" src="#happy-2-asset" position="0 0 0" rotation="0 0 0" scale="3 3 3"
                    animation-mixer="loop: once" visible="false">
                </a-gltf-model>
                <a-gltf-model id="happy-3-model" src="#happy-3-asset" position="0 0 0" rotation="0 0 0" scale="3 3 3"
                    animation-mixer="loop: once" visible="false">
                </a-gltf-model>

                <!-- Angry Models (1 variant) -->
                <a-gltf-model id="angry-model" src="#angry-asset" position="0 0 0" rotation="0 0 0" scale="3 3 3"
                    animation-mixer="loop: once" visible="false">
                </a-gltf-model>

                <!-- Anger Icon (üí¢) -->
                <a-text id="anger-icon" value="üí¢" position="-0.5 2 0" rotation="0 0 0" scale="2 2 2" color="#FF0000"
                    align="center" visible="false">
                </a-text>

                <!-- Heart Icon (‚ù§) -->
                <a-text id="heart-icon" value="‚ù§" position="-0.5 2 0" rotation="0 0 0" scale="2 2 2" color="#FF1493"
                    align="center" visible="false">
                </a-text>
            </a-entity>

        </a-marker>

        <!-- Hiro Marker -->
        <a-marker preset="hiro">
            <a-gltf-model src="#buddy-asset" position="0 0 0" rotation="0 0 0" scale="1.5 1.5 1.5"
                animation-mixer="loop: once">
            </a-gltf-model>
        </a-marker>

        <a-entity camera></a-entity>

    </a-scene>
</body>

</html>