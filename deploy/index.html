<!DOCTYPE html>
<html>

<head>
    <title>Marker-based Animal AR - Evolution</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <style>
        .ui-button {
            position: absolute;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #333;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .ui-button:active {
            transform: scale(0.95);
            background: rgba(200, 200, 200, 0.9);
        }

        #switch-btn {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 182, 193, 0.9);
        }

        #happy-btn {
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            background: rgba(255, 255, 153, 0.9);
        }

        #angry-btn {
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(255, 153, 153, 0.9);
        }

        #message-box {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            line-height: 1.5;
            z-index: 2000;
            text-align: center;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }
    </style>
    <script>
        // --- çŠ¶æ…‹ç®¡ç†ç”¨å¤‰æ•° ---
        let currentStage = 0; // 0: egg, 1: rubber_duck, 2: duck
        let lastProcessedTimestamp = 0;

        // --- ã‚·ãƒ¼ãƒ³åˆæœŸåŒ–æ™‚ã®å‡¦ç† ---
        document.addEventListener('DOMContentLoaded', function () {
            const scene = document.querySelector('a-scene');

            scene.addEventListener('loaded', () => {
                const egg = document.querySelector('#egg');
                const rubberDuck = document.querySelector('#rubber-duck');
                const duck = document.querySelector('#duck');
                const sparkles = document.querySelectorAll('.sparkle');

                // ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹é–¢æ•°
                function triggerSparkle() {
                    sparkles.forEach((sparkle) => {
                        sparkle.removeAttribute('animation');
                        sparkle.removeAttribute('animation__opacity');
                        sparkle.setAttribute('position', '0 0.5 0');
                        sparkle.setAttribute('material', 'opacity', 1);
                        sparkle.setAttribute('visible', true);

                        setTimeout(() => {
                            const randomX = (Math.random() - 0.5) * 1.2;
                            const randomY = 0.5 + Math.random() * 1.0;
                            const randomZ = (Math.random() - 0.5) * 1.2;

                            sparkle.setAttribute('animation', {
                                property: 'position',
                                from: '0 0.5 0',
                                to: `${randomX} ${randomY} ${randomZ}`,
                                dur: 800,
                                easing: 'easeOutQuad'
                            });
                            sparkle.setAttribute('animation__opacity', {
                                property: 'material.opacity',
                                from: 1,
                                to: 0,
                                dur: 800,
                                easing: 'easeInQuad'
                            });
                        }, 10);
                    });

                    setTimeout(() => {
                        sparkles.forEach(sparkle => {
                            sparkle.setAttribute('visible', false);
                            sparkle.setAttribute('position', '0 0.5 0');
                            sparkle.setAttribute('material', 'opacity', 1);
                        });
                    }, 1000);
                }

                // é€²åŒ–ã‚·ã‚¹ãƒ†ãƒ 
                document.getElementById('switch-btn').addEventListener('click', function () {
                    console.log("é€²åŒ–");
                    triggerSparkle();

                    // ç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«ã‚’éè¡¨ç¤º
                    egg.setAttribute('visible', false);
                    rubberDuck.setAttribute('visible', false);
                    duck.setAttribute('visible', false);

                    // æ¬¡ã®æ®µéšã¸é€²åŒ–
                    currentStage = (currentStage + 1) % 3;

                    // æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ã‚’è¡¨ç¤º
                    if (currentStage === 0) {
                        egg.setAttribute('visible', true);
                        egg.removeAttribute('animation');
                    } else if (currentStage === 1) {
                        rubberDuck.setAttribute('visible', true);
                        rubberDuck.removeAttribute('animation');
                    } else {
                        duck.setAttribute('visible', true);
                        duck.removeAttribute('animation');
                    }
                });

                // å–œã³è¡¨ç¾
                document.getElementById('happy-btn').addEventListener('click', function () {
                    console.log("å–œã³è¡¨ç¾");
                    const currentModel = currentStage === 0 ? egg : (currentStage === 1 ? rubberDuck : duck);

                    // ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«ã¨å›è»¢ã‚’å–å¾—
                    let baseScale, baseRotation;
                    if (currentStage === 0) {
                        baseScale = '0.03 0.03 0.03';
                        baseRotation = '0 0 0';
                    } else if (currentStage === 1) {
                        baseScale = '3.0 3.0 3.0';
                        baseRotation = '0 -90 0';
                    } else {
                        baseScale = '0.3 0.3 0.3';
                        baseRotation = '0 0 0';
                    }

                    currentModel.removeAttribute('animation__happy');
                    currentModel.removeAttribute('animation__happy_scale');
                    currentModel.setAttribute('rotation', baseRotation);
                    currentModel.setAttribute('scale', baseScale);

                    setTimeout(() => {
                        let animFrom, animTo;
                        if (currentStage === 1) {
                            // ãƒ©ãƒãƒ¼ãƒ€ãƒƒã‚¯ç”¨ï¼ˆYè»¸-90åº¦ã‚’ç¶­æŒï¼‰
                            animFrom = '0 -90 -15';
                            animTo = '0 -90 15';
                        } else {
                            // åµã¨ã‚¢ãƒ’ãƒ«ç”¨
                            animFrom = '0 0 -15';
                            animTo = '0 0 15';
                        }

                        currentModel.setAttribute('animation__happy', {
                            property: 'rotation',
                            from: animFrom,
                            to: animTo,
                            dur: 300,
                            easing: 'easeInOutSine',
                            dir: 'alternate',
                            loop: 3
                        });
                    }, 10);
                });

                // æ€’ã‚Šè¡¨ç¾
                document.getElementById('angry-btn').addEventListener('click', function () {
                    console.log("æ€’ã‚Šè¡¨ç¾");
                    const currentModel = currentStage === 0 ? egg : (currentStage === 1 ? rubberDuck : duck);

                    // ç¾åœ¨ã®å›è»¢ã‚’å–å¾—
                    let baseRotation;
                    if (currentStage === 0) {
                        baseRotation = '0 0 0';
                    } else if (currentStage === 1) {
                        baseRotation = '0 -90 0';
                    } else {
                        baseRotation = '0 0 0';
                    }

                    currentModel.removeAttribute('animation__angry');
                    currentModel.setAttribute('rotation', baseRotation);

                    setTimeout(() => {
                        let animFrom, animTo;
                        if (currentStage === 1) {
                            // ãƒ©ãƒãƒ¼ãƒ€ãƒƒã‚¯ç”¨ï¼ˆYè»¸-90åº¦ã‚’ç¶­æŒï¼‰
                            animFrom = '0 -90 -5';
                            animTo = '0 -90 5';
                        } else {
                            // åµã¨ã‚¢ãƒ’ãƒ«ç”¨
                            animFrom = '0 0 -5';
                            animTo = '0 0 5';
                        }

                        currentModel.setAttribute('animation__angry', {
                            property: 'rotation',
                            from: animFrom,
                            to: animTo,
                            dur: 100,
                            easing: 'linear',
                            dir: 'alternate',
                            loop: 8
                        });

                        const modelEl = currentModel.components['gltf-model'];
                        if (modelEl && modelEl.model) {
                            modelEl.model.traverse((node) => {
                                if (node.isMesh && node.material) {
                                    const originalColor = node.material.color.clone();
                                    node.material.color.setHex(0xff0000);
                                    setTimeout(() => {
                                        node.material.color.copy(originalColor);
                                    }, 800);
                                }
                            });
                        }
                    }, 10);
                });

                // --- APIè¨­å®š ---
                let API_ENDPOINT = '';
                const USER_ID = 'user_A';

                // è¨­å®šã‚’èª­ã¿è¾¼ã‚€
                async function loadConfig() {
                    try {
                        const response = await fetch('./amplify_outputs.json');
                        const config = await response.json();
                        if (config.custom && config.custom.API) {
                            const apiName = Object.keys(config.custom.API)[0];
                            API_ENDPOINT = config.custom.API[apiName].endpoint;
                            console.log('API Endpoint loaded:', API_ENDPOINT);
                        } else {
                            console.warn('API configuration not found in amplify_outputs.json');
                        }
                    } catch (error) {
                        console.error('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }

                loadConfig();

                // --- DBã‹ã‚‰æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•° ---
                async function checkEmotionData() {
                    if (!API_ENDPOINT) return;

                    try {
                        // API Gatewayã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        const response = await fetch(`${API_ENDPOINT}/data?userId=${USER_ID}`);
                        const data = await response.json();

                        // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã®ã¿å‡¦ç†
                        if (data.timestamp && data.timestamp > lastProcessedTimestamp) {
                            lastProcessedTimestamp = data.timestamp;
                            console.log('æ–°ã—ã„æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿:', data.emotion);

                            // æ„Ÿæƒ…ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
                            switch (data.emotion) {
                                case 'happy':
                                    document.getElementById('happy-btn').click();
                                    break;
                                case 'angry':
                                    document.getElementById('angry-btn').click();
                                    break;
                                case 'switch':
                                    document.getElementById('switch-btn').click();
                                    break;
                            }
                        }
                    } catch (error) {
                        console.error('æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }

                // 1ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
                setInterval(checkEmotionData, 1000);
                console.log('æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã®ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
            });
        });
    </script>
</head>

<body style="margin: 0; overflow: hidden;">
    <!-- UIãƒœã‚¿ãƒ³ -->
    <button id="switch-btn" class="ui-button">ğŸ¥š é€²åŒ–</button>
    <button id="happy-btn" class="ui-button">ğŸ˜Š å–œã³</button>
    <button id="angry-btn" class="ui-button">ğŸ˜  æ€’ã‚Š</button>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ -->
    <div id="message-box">
        ãŠé‡èœã®å±Šãã¤ã¤å¾…ã¡ãã ã•ã„ã€‚ã©ã‚“ã©ã“ã„ã§ã™ï¼
    </div>

    <a-scene embedded arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'>

        <a-assets>
            <a-asset-item id="egg-model-asset" src="egg_fbx.glb"></a-asset-item>
            <a-asset-item id="rubber-duck-model-asset" src="rubber_duck.glb"></a-asset-item>
            <a-asset-item id="duck-model-asset" src="duck.glb"></a-asset-item>
        </a-assets>

        <!-- Custom Marker -->
        <a-marker type='pattern' url='pattern-WBF.patt?v=3'>

            <a-entity id="model-container">
                <a-gltf-model id="egg" src="#egg-model-asset" position="0 0.1 0" rotation="0 0 0" scale="0.03 0.03 0.03"
                    animation-mixer visible="true">
                </a-gltf-model>

                <a-gltf-model id="rubber-duck" src="#rubber-duck-model-asset" position="0 0.1 0" rotation="0 -90 0"
                    scale="3.0 3.0 3.0" animation-mixer visible="false">
                </a-gltf-model>

                <a-gltf-model id="duck" src="#duck-model-asset" position="0 0.1 0" rotation="0 0 0" scale="0.3 0.3 0.3"
                    animation-mixer visible="false">
                </a-gltf-model>

                <!-- ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
                <a-sphere class="sparkle" position="0 0.5 0" radius="0.06" color="#FFD700"
                    material="opacity: 1; transparent: true" visible="false"></a-sphere>
                <a-sphere class="sparkle" position="0 0.5 0" radius="0.06" color="#FFA500"
                    material="opacity: 1; transparent: true" visible="false"></a-sphere>
                <a-sphere class="sparkle" position="0 0.5 0" radius="0.06" color="#FFFFFF"
                    material="opacity: 1; transparent: true" visible="false"></a-sphere>
                <a-sphere class="sparkle" position="0 0.5 0" radius="0.06" color="#FFD700"
                    material="opacity: 1; transparent: true" visible="false"></a-sphere>
                <a-sphere class="sparkle" position="0 0.5 0" radius="0.06" color="#FFA500"
                    material="opacity: 1; transparent: true" visible="false"></a-sphere>
                <a-sphere class="sparkle" position="0 0.5 0" radius="0.06" color="#FFFFFF"
                    material="opacity: 1; transparent: true" visible="false"></a-sphere>
                <a-sphere class="sparkle" position="0 0.5 0" radius="0.06" color="#FFD700"
                    material="opacity: 1; transparent: true" visible="false"></a-sphere>
                <a-sphere class="sparkle" position="0 0.5 0" radius="0.06" color="#FFA500"
                    material="opacity: 1; transparent: true" visible="false"></a-sphere>
            </a-entity>

        </a-marker>

        <a-entity camera></a-entity>

    </a-scene>
</body>

</html>